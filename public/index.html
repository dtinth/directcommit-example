<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>directcommit example</title>
    <style>
      #data {
        width: 100%;
        box-sizing: border-box;
        height: 90vh;
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <h1>Loadingâ€¦</h1>
    </div>

    <div id="not-signed-in" hidden>
      <h1>Not signed in</h1>
      <button id="sign-in">Sign in with GitHub</button>
    </div>

    <div id="app" hidden>
      <h1>Signed in as <span id="username"></span></h1>
      <button id="sign-out">Sign out</button>
      <form id="edit">
        Editing README file<br />
        <textarea id="data" disabled>Loading...</textarea>
        <button id="submit">Save</button>
      </form>
    </div>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.8.4/firebase-app.js'
      import {
        getAuth,
        GithubAuthProvider,
        signInWithPopup,
        onAuthStateChanged,
      } from 'https://www.gstatic.com/firebasejs/9.8.4/firebase-auth.js'
      import * as base64 from 'https://cdn.skypack.dev/@stablelib/base64'

      const backendBase =
        new URLSearchParams(window.location.search).get('backend') ||
        'https://directcommit-production.up.railway.app'

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: 'AIzaSyDLDD_KtKkfAj9sgOHupxUuDt_p8g19bkU',
        authDomain: 'fiery-react.firebaseapp.com',
        databaseURL: 'https://fiery-react.firebaseio.com',
        projectId: 'fiery-react',
        storageBucket: 'fiery-react.appspot.com',
        messagingSenderId: '284926450412',
        appId: '1:284926450412:web:4e669315ebbd1cc163a3c9',
      }

      // Initialize Firebase
      const app = initializeApp(firebaseConfig)
      const auth = getAuth(app)

      // Sign in with GitHub
      const provider = new GithubAuthProvider()

      const $ = document.querySelector.bind(document)
      let sha

      $('#sign-in').addEventListener('click', () => {
        signInWithPopup(auth, provider).catch((error) => {
          console.error(error)
          alert(`Unable to sign in: ${error.message}`)
        })
      })

      onAuthStateChanged(auth, async (user) => {
        $('#loading').hidden = true
        $('#not-signed-in').hidden = !!user
        $('#app').hidden = !user
        if (user) {
          $('#username').textContent = user.displayName || user.email
          try {
            const idToken = await user.getIdToken()
            const response = await fetch(
              new URL(
                'api/mountpoints/directcommit/contents/README.md',
                backendBase,
              ),
              {
                headers: {
                  Authorization: `Bearer ${idToken}`,
                },
              },
            )
            if (!response.ok) {
              throw new Error(`Request failed: ${response.status}`)
            }
            const data = await response.json()
            $('#data').value = new TextDecoder().decode(
              base64.decode(data.content.replace(/\s/g, '')),
            )
            $('#data').disabled = false
            sha = data.sha
          } catch (error) {
            alert(`Unable to fetch README: ${error.message}`)
          }
        }
      })

      $('#edit').addEventListener('submit', async (event) => {
        try {
          event.preventDefault()
          $('#submit').disabled = true
          const content = $('#data').value
          const idToken = await auth.currentUser.getIdToken()
          const response = await fetch(
            new URL(
              'api/mountpoints/directcommit/contents/README.md',
              backendBase,
            ),
            {
              method: 'PUT',
              headers: {
                Authorization: `Bearer ${idToken}`,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                message: 'Update README file',
                content: base64.encode(new TextEncoder().encode(content)),
                sha,
              }),
            },
          )
          if (!response.ok) {
            throw new Error(`Request failed: ${response.status}`)
          }
          const data = await response.json()
          sha = data.content.sha
          alert('Saved! sha: ' + sha)
        } catch (error) {
          alert(`Unable to save README: ${error.message}`)
        } finally {
          $('#submit').disabled = false
        }
      })
    </script>
  </body>
</html>
